{% import 'macros_profile_overview.html.jinja2' as profile_overview %}
{% import 'macros_html_widgets.html.jinja2' as widgets %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.30.0.min.js'></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/2.0.3/js/dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/2.0.0/js/dataTables.select.min.js"></script>
    <style>
        html {
            font-family: "Courier New", Courier, monospace;
        }
        .column {
            width: 48%;
            margin: 0 1%;
        }
        .left {
            float: left;
        }
        .right {
            float: right;
        }
        .middle {
            width: 98%;
            float: left;
            margin: 0 1%;
            justify-content: center;
        }
        .column-head {
            border-bottom: 1px solid #ddd;
            border-top: 1px solid #ddd;
            text-align: center;
        }

        div.tools table {
            border-collapse: collapse;
            border-bottom: 1px solid #ddd;
            margin: 0 auto 0 auto;
        }

        div.tools td.value {
            padding: 1em 0.5em;
            text-align: left;
        }

        div.tools td.key {
            padding: 1em 0.5em;
            text-align: right;
            font-weight: bold;
        }
        div.tools td.check_option {
            padding: 1em 0.5em;
        }
        div.tools td.topkey {
            padding: 1em 0 0;
            text-align: center;
            font-weight: bold;
        }

        div.tools table.nested {
            border: none;
        }

        table#sankey_tools {
            width: 100%;
            margin: 0 1%;
        }
        table#sankey_tools tbody {
            width: 100%;
        }

        tr.highlight {
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background-color: #eee;
        }

        table:hover tr.highlight {
            background-color: #ccc;
        }

        /* Style the tab */
        .tab {
          overflow: hidden;
          border: 1px solid #ccc;
          background-color: #f1f1f1;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
          background-color: inherit;
          float: left;
          border: none;
          outline: none;
          cursor: pointer;
          padding: 14px 16px;
          transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
          background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
          background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
          display: none;
          width: 100%;
          float: left;
          padding: 6px 0px;
          border: 1px solid #ccc;
          border-top: none;
        }

        {{ profile_overview.css_style() }}
        {{ widgets.range_picker_style() }}

        #label_baseline {
            border-bottom: 5px solid {{ palette.Baseline }};
        }
        #label_target {
            border-bottom: 5px solid {{ palette.Target }};
        }
        #label_incr {
            border-bottom: 5px solid {{ palette.Increase }};
        }
        #label_both {
            border-bottom: 5px solid {{ palette.Equal }};
        }
        #label_decr {
            border-bottom: 5px solid {{ palette.Decrease }};
        }
        tr.shown span.minus {
            display: block;
        }
        tr.shown span.plus {
            display: none;
        }
        tr.hidden span.plus {
            display: block;
        }
        tr.hidden span.minus {
            display: none;
        }
        .increase {
            font-weight: bold;
            color: {{ palette.DarkIncrease }};
        }
        .decrease {
            font-weight: bold;
            color: {{ palette.DarkDecrease }};
        }
        .equal {
            font-weight: bold;
            color: {{ palette.DarkEqual }};
        }
        .svg-container {
            display: inline-block;
            position: relative;
            width: 100%;
            vertical-align: top;
            overflow: hidden;
        }

        div.column .svg-container {
            padding-bottom: 100%;
        }

        .svg-content {
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
        }
        {{ widgets.tooltip_style() }}
    </style>
</head>
<body>

<div class="left column">
    <h2 class="column-head">{{ lhs_tag }}</h2>
    {{ profile_overview.overview_table('toggleLeftCollapse', 'left-info', lhs_header, rhs_header) }}
    <div style="margin: 0 10px;">&nbsp;</div>
</div>

<div class="right column">
    <h2 class="column-head">{{ rhs_tag }}</h2>
    {{ profile_overview.overview_table('toggleRightCollapse', 'right-info', rhs_header, lhs_header) }}
    <div style="margin: 0 10px;">&nbsp;</div>
</div>

<div class="middle">
    <div class="tools">
        <div class="tab">
            {%- if flamegraphs %}
            {%- for metric in stat_list %}
            <button class="tablinks" onclick="openTab(event, '{{ metric|sanitize_variable_name }}')" {% if loop.index0 == 0 %}id="defaultOpen"{% endif %}>Top {{ metric }}</button>
            {%- endfor %}
            {%- endif %}
            <button class="tablinks" onclick="openTab(event, 'all')">Browse All</button>
        </div>
        <div id="all" class="tabcontent">
            <table id="table" class="display" style="width: 100%;">
                <thead>
                <tr>
                    <th></th>
                    <th>Unit</th>
                    <th>Change</th>
                    <th>Metric</th>
                    <th>Absolute</th>
                    <th>Relative</th>
                </tr>
                </thead>
            </table>
        </div>
        {% for (metric, lhs_flamegraph, rhs_flamegraph, diff_flamegraph) in flamegraphs %}
        <div id="{{ metric|sanitize_variable_name }}" class="tabcontent">
            <div class="left column">
                <div class='svg-container'>
                    {{ lhs_flamegraph}}
                </div>
            </div>
            <div class="right column">
                <div class='svg-container'>
                    {{ rhs_flamegraph }}
                </div>
            </div>
        </div>
        {%- endfor %}
        <div id="sankey_tools" style="display: none">
            <table>
                <tbody>
                    <tr>
                        <td class="key" style="width: 20%;">Threshold:</td>
                        <td colspan="6">{{ widgets.range_picker() }}</td>
                    </tr>
                    {{ widgets.checkboxes([('baseline', 'Baseline'), ('target', 'Target'), ('incr', 'Incr (vs base)'), ('both', 'Equal'), ('decr', 'Decr (vs base)')], 'show_edges', 'Show') }}
                    {%- if stat_list|length > 1 %}
                    <tr>
                        <td class="key" style="width: 20%;">Metric:</td>
                        <td colspan="6">
                            <select class="dt-input" id="metricSelection">
                                {%- for metric in stat_list %}
                                    <option value="{{ loop.index0 }}">{{ metric }}</option>
                                {%- endfor %}
                            </select>
                        </td>
                    </tr>
                {%- endif %}
                </tbody>
            </table>
        </div>
    </div>

   <div id="sankey_graph"><!-- DO NOT CHANGE: SANKEY GRAPH IS RENDERED HERE--></div>
</div>

<script>
    //<!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
    const selection_icon = {
        'width': 512,
        'height': 512,
        'path': 'M256 0c-25.3 0-47.2 14.7-57.6 36c-7-2.6-14.5-4-22.4-4c-35.3 0-64 28.7-64 64V261.5l-2.7-2.7c-25-25-65.5-25-90.5 0s-25 65.5 0 90.5L106.5 437c48 48 113.1 75 181 75H296h8c1.5 0 3-.1 4.5-.4c91.7-6.2 165-79.4 171.1-171.1c.3-1.5 .4-3 .4-4.5V160c0-35.3-28.7-64-64-64c-5.5 0-10.9 .7-16 2V96c0-35.3-28.7-64-64-64c-7.9 0-15.4 1.4-22.4 4C303.2 14.7 281.3 0 256 0zM240 96.1c0 0 0-.1 0-.1V64c0-8.8 7.2-16 16-16s16 7.2 16 16V95.9c0 0 0 .1 0 .1V232c0 13.3 10.7 24 24 24s24-10.7 24-24V96c0 0 0 0 0-.1c0-8.8 7.2-16 16-16s16 7.2 16 16v55.9c0 0 0 .1 0 .1v80c0 13.3 10.7 24 24 24s24-10.7 24-24V160.1c0 0 0-.1 0-.1c0-8.8 7.2-16 16-16s16 7.2 16 16V332.9c-.1 .6-.1 1.3-.2 1.9c-3.4 69.7-59.3 125.6-129 129c-.6 0-1.3 .1-1.9 .2H296h-8.5c-55.2 0-108.1-21.9-147.1-60.9L52.7 315.3c-6.2-6.2-6.2-16.4 0-22.6s16.4-6.2 22.6 0L119 336.4c6.9 6.9 17.2 8.9 26.2 5.2s14.8-12.5 14.8-22.2V96c0-8.8 7.2-16 16-16c8.8 0 16 7.1 16 15.9V232c0 13.3 10.7 24 24 24s24-10.7 24-24V96.1z'
    }
    const plus_icon = {
        'width': 512,
        'height': 512,
        'path': 'M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM200 344V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H248v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z'
    }
    const minus_icon = {
        'width': 512,
        'height': 512,
        'path': 'M64 80c-8.8 0-16 7.2-16 16V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V96c0-8.8-7.2-16-16-16H64zM0 96C0 60.7 28.7 32 64 32H384c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM152 232H296c13.3 0 24 10.7 24 24s-10.7 24-24 24H152c-13.3 0-24-10.7-24-24s10.7-24 24-24z'
    }
    const rotate_icon = {
        'width': 512,
        'height': 512,
        'path': 'M142.9 142.9c62.2-62.2 162.7-62.5 225.3-1L327 183c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H463.5c0 0 0 0 0 0H472c13.3 0 24-10.7 24-24V72c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2L413.4 96.6c-87.6-86.5-228.7-86.2-315.8 1C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5c7.7-21.8 20.2-42.3 37.8-59.8zM16 312v7.6 .7V440c0 9.7 5.8 18.5 14.8 22.2s19.3 1.7 26.2-5.2l41.6-41.6c87.6 86.5 228.7 86.2 315.8-1c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.2 62.2-162.7 62.5-225.3 1L185 329c6.9-6.9 8.9-17.2 5.2-26.2s-12.5-14.8-22.2-14.8H48.4h-.7H40c-13.3 0-24 10.7-24 24z'
    }
    const maximize_icon = {
        'width': 512,
        'height': 512,
        'path': 'M200 32H56C42.7 32 32 42.7 32 56V200c0 9.7 5.8 18.5 14.8 22.2s19.3 1.7 26.2-5.2l40-40 79 79-79 79L73 295c-6.9-6.9-17.2-8.9-26.2-5.2S32 302.3 32 312V456c0 13.3 10.7 24 24 24H200c9.7 0 18.5-5.8 22.2-14.8s1.7-19.3-5.2-26.2l-40-40 79-79 79 79-40 40c-6.9 6.9-8.9 17.2-5.2 26.2s12.5 14.8 22.2 14.8H456c13.3 0 24-10.7 24-24V312c0-9.7-5.8-18.5-14.8-22.2s-19.3-1.7-26.2 5.2l-40 40-79-79 79-79 40 40c6.9 6.9 17.2 8.9 26.2 5.2s14.8-12.5 14.8-22.2V56c0-13.3-10.7-24-24-24H312c-9.7 0-18.5 5.8-22.2 14.8s-1.7 19.3 5.2 26.2l40 40-79 79-79-79 40-40c6.9-6.9 8.9-17.2 5.2-26.2S209.7 32 200 32z'
    }

    const minimize_icon = {
        'width': 512,
        'height': 512,
        'path': 'M456 224H312c-13.3 0-24-10.7-24-24V56c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2l40 40L442.3 5.7C446 2 450.9 0 456 0s10 2 13.7 5.7l36.7 36.7C510 46 512 50.9 512 56s-2 10-5.7 13.7L433 143l40 40c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8zm0 64c9.7 0 18.5 5.8 22.2 14.8s1.7 19.3-5.2 26.2l-40 40 73.4 73.4c3.6 3.6 5.7 8.5 5.7 13.7s-2 10-5.7 13.7l-36.7 36.7C466 510 461.1 512 456 512s-10-2-13.7-5.7L369 433l-40 40c-6.9 6.9-17.2 8.9-26.2 5.2s-14.8-12.5-14.8-22.2V312c0-13.3 10.7-24 24-24H456zm-256 0c13.3 0 24 10.7 24 24V456c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-40-40L69.7 506.3C66 510 61.1 512 56 512s-10-2-13.7-5.7L5.7 469.7C2 466 0 461.1 0 456s2-10 5.7-13.7L79 369 39 329c-6.9-6.9-8.9-17.2-5.2-26.2s12.5-14.8 22.2-14.8H200zM56 224c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l40-40L5.7 69.7C2 66 0 61.1 0 56s2-10 5.7-13.7L42.3 5.7C46 2 50.9 0 56 0s10 2 13.7 5.7L143 79l40-40c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2V200c0 13.3-10.7 24-24 24H56z'
    }

    // Graph data
    {% autoescape off %}
    let caller_graph = {{ caller_graph }}
    let callee_graph = {{ callee_graph }}
    let nodes = {{ nodes }}
    let stats = {{ stats }}
    let stat_map = {{ stat_list }}
    let node_map = {{ node_map }}
    {% endautoescape %}

    let sankey_data = [{
        type: "sankey",
        arrangement: "fixed",
        orientation: "v",
        node: {
            pad: 15,
            thickness: 20,
            line: {
                color: "black",
                width: 1
            },
            label: [],
            color: [],
            customdata: []
        },
        link: {
            source: [],
            target: [],
            value: [],
            color: [],
            customdata: []
        }
        }],
        shown_nodes = [],
        processed_edges = new Set();
        steps = [1],
        config = {
            responsive: true,
            modeBarButtonsToAdd: [
                {
                    name: 'Move Nodes',
                    icon: selection_icon,
                    click: function(gd) {
                        modification_mode = "none";
                        Plotly.update(gd, {arrangement: "snap"});
                    }
                }, {
                    name: 'Expand Nodes',
                    icon: plus_icon,
                    click: function (gd) {
                        modification_mode = "unfold";
                        Plotly.update(gd, {arrangement: "fixed"});
                    }
                }, {
                    name: "Fold Nodes",
                    icon: minus_icon,
                    click: function (gd) {
                        modification_mode = "fold";
                        Plotly.update(gd, {arrangement: "fixed"});
                    }
                }, {
                    name: "Minimize Graph",
                    icon: minimize_icon,
                    click: function (gd) {
                        initializeGraph();
                    }
                }, {
                    name: "Expand By One Level",
                    icon: maximize_icon,
                    click: function (gd) {
                        expandOneLevel();
                    }
                }, {
                    name: 'Rotate Graph',
                    icon: rotate_icon,
                    click: function(gd) {
                        if (sankey_data[0].orientation === "v") {
                            sankey_data[0].orientation = "h";
                        } else {
                            sankey_data[0].orientation = "v";
                        }
                        Plotly.update(gd, {orientation: sankey_data[0].orientation});
                    }
                },
            ],
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        },
        layout = {
            title: "",
            font: {
                size: 14
            },
            height: 600,
        },
        selected_metric = 0,
        modification_mode = "none",
        number_of_metrics = {{ stat_list|length }},
        selected_uid = -1,
        selected_uid_text = "",
        plot = document.getElementById('sankey_graph');

    // Selection table
    let table = {"data":[{%- for val in selection_table %}{"uid":"{{ val.uid }}","index":"{{ val.index }}","fresh": "{{ val.fresh }}","stats": {{ val.stats|map('list')|list }},"traces": {{ val.trace_stats|map('list')|list }},"type": "{{ val.main_stat }}","abs": "{{ val.abs_amount }}","rel": "{{ val.rel_amount }}" },{%- endfor %}]};
    let selection_table = $("#table").DataTable({
        data: table.data,
        columns: [
            {
                className: "details-control",
                orderable: false,
                data: null,
                defaultContent: "",
                render: function () {
                    return '<span class="plus">[+]</span><span class="minus">[-]</span>';
                },
                width: "15px"
            },
            { data: "uid" , className: "details-uid"},
            {
                data: "fresh",
                render: function (data, type) {
                    if (type ==='display') {
                        if (data === "new") {
                            return '<span style="font-weight: bold; color: {{ palette.DarkTarget }}">' + data + "</span>";
                        } else if (data == "removed") {
                            return '<span style="font-weight: bold; color: {{ palette.DarkBaseline }}">' + data + "</span>";
                        } else {
                            return '<span style="font-weight: bold; color: {{ palette.Equal }}">' + data + "</span>";
                        }
                    }
                    return data;
                }
            },
            { 
                data: "type",
                render: function(data, type) {
                    if (type === 'display') {
                        return stat_id_to_name(data);
                    }
                    return data;
                }
            }, {
                data: "abs",
                className: "dt-body-right",
                render: function (data, type) {
                    if (type === 'display') {
                        return format_value(data);
                    }
                    return data;
                },
            },
            {
                data: "rel",
                render: function(data, type) {
                    if (type === 'display') {
                        return format_relative(data);
                    }
                    return data;
                }},
            { data: "index", visible: false},
        ],
        order: [[4, "desc"]],
        iDisplayLength: 10,
        select: true,
        createdRow: function( row, data, dataIndex ) {
            $( row ).addClass('hidden');
        },
    })
    selection_table.on('user-select', function (e, dt, type, cell, originalEvent) {
        if (originalEvent.target.cellIndex === 0 || originalEvent.target.tagName === "SPAN") {
            e.preventDefault();
        }
    });

    {{ profile_overview.toggle_script('toggleLeftCollapse', 'left-info') }}
    {{ profile_overview.toggle_script('toggleRightCollapse', 'right-info') }}

    {{ widgets.checkbox_handler() }}
    {{ widgets.range_handlers() }}

    function format_value(val) {
        let result = "<span"
        if (typeof val !== "number") {
            val = Number(val);
        }
        if (val > 0) {
            result += ' style="font-weight: bold; color: {{ palette.DarkIncrease }}';
        } else if (val < 0) {
            result += ' style="font-weight: bold; color: {{ palette.DarkDecrease }}';
        }
        result += '">'
        result += val.toLocaleString();
        result += "</span>";
        return result;
    }

    function format_relative(value) {
        if (typeof value !== "number") {
            value = Number(value);
        }
        if (Math.abs(value) >= 0 && Math.abs(value) <= 1) {
            value = value * 100
        }
        let fixedValue = Number(value).toFixed(2)
        let result = '<span style="font-weight: bold; ';
        if (value > 0 && value <= 100) {
            result += 'color: {{ palette.DarkIncrease }}"';
        } else if (value >= -100 && value < 0) {
            result += 'color: {{ palette.DarkDecrease }}"';
        } else {
            result += 'color: {{ palette.DarkEqual}}"';
        }
        result += '">'
        result += fixedValue + "%</span>";
        return result;
    }

    function format_stat(baseline, target) {
        let result = "";
        if (baseline === target) {
            result += '<span class="equal">' + formatSize(baseline) + '</span>';
        } else if (baseline < target) {
            result += '<span class="increase">' + formatSize(baseline) + ' ↗ ' + formatSize(target) + '</span>';
        } else {
            result += '<span class="decrease">' + formatSize(baseline) + ' ↘ ' + formatSize(target) + '</span>';
        }
        return result;
    };

    function format_path_prex(path_stats, index, path_cost) {
        let result = '<span class="';
        let prefix_sum = path_stats.slice(0, index+1).reduce((acc, v) => acc + v, 0);
        let prefix_rate = (path_cost === 0) ? 0 : (prefix_sum / path_cost);
        if (prefix_rate < 0.5) {
            result += 'decrease';
        } else if (prefix_rate > 0.5) {
            result += 'increase';
        } else {
            result += 'equal';
        }
        result += '">' + format_value(prefix_sum) + ' (' + (prefix_rate * 100).toFixed(2) + '%)</span>';
        result += '{{ widgets.tooltip("Prefix cost: the sum up to the current uid") }}'
        return result;
    }

    function getColor(n) {
        let R = (255 * n) / 100,
            G = (255 * (100 - n)) / 100
            B = 0;
        return "rgba(" + R + ", " + G + ", " + B + ", 1.0)";
    }

    function format_bottleneck(stat, min) {
        // TODO: Add gradient colours
        let result = '<span style="font-weight: bold; color: ';
        let bottleneck_rate = (stat === 0) ? 0 : min / stat;
        result += getColor(bottleneck_rate * 100);
        result += '">' + (bottleneck_rate * 100).toFixed(2) + '%</span>';
        result += '{{ widgets.tooltip('<span style="font-weight: bold">Bottleneck rate:</span> the ratio between the cost of the whole path to all paths leading to the current uid') }}'
        return result;
    };

    function format_sub_row(d, uid) {
        let result = '<table style="width: 100%; border: none;" class="nested">';
        let stat_type = d[2].toLowerCase();
        let parts = d[5].split('#');
        let traces = parts[0].split(';'), baseline = parts[1].split(';').map(Number), target = parts[2].split(';').map(Number);
        let min_baseline = Math.min(...baseline), min_target = Math.min(...target);
        let sum_baseline = baseline.reduce((acc, v) => acc + v, 0), sum_target = target.reduce((acc, v) => acc + v, 0);
        traces.forEach((v, i) => {
            let node = nodes[v];
            result += '<tr><td style="white-space: pre-wrap">';
            if (i != 0 && i != traces.length) {
                let baseline_stat = baseline[i-1],
                    target_stat = target[i-1];
                let diff = baseline_stat - target_stat;
                result += '  '.repeat(i) + "⎸ " + format_stat(baseline_stat, target_stat);
                if (stat_type.includes("inclusive")) {
                    result += "    ";
                    result += format_bottleneck(baseline_stat, min_baseline);
                    result += " | ";
                    result += format_bottleneck(target_stat, min_target);
                } else if (stat_type.includes("exclusive")) {
                    result += "    ";
                    result += format_path_prex(baseline, i-1, sum_baseline);
                    result += " | ";
                    result += format_path_prex(target, i-1, sum_target);
                }
                result += " "
            }
            result += '</td></tr>';
            result += '<tr'
            if (node === uid) {
                result += ' class="highlight"';
            }
            result += '><td style="white-space: pre-wrap">';
            if (i !== 0) {
                result += '  '.repeat(i) + "⤷ ";
            }
            result += (node === uid) ? '<span style="font-weight: bold">' + node + '</span>' : node;
            result += "</td></tr>";
        });
        result += '</table>';
        return result
    };

    function format_row(d) {
        let result = '<table id="metrics' + d.index + '" class="display" style="width:100%; border-right: 10px solid #ddd; border-left: 10px solid #ddd;">';
        result += "<thead><tr><th>Metric</th><th>Absolute</th><th>Relative</th></tr></thead><tbody>";
        d.stats.forEach((value, index) => {
            result += "<tr>";
            result += '<td style="white-space: pre-wrap">' + value[0] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[1] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[2] + "</td>";
            result += "</tr>";
        });
        result += '</tbody></table>';
        result += '<h4 style="text-align: center; width: 100%; border-bottom: 1px solid #ddd;">Top ' + d.traces.length + ' Traces</h4>';
        result += '<table id="traces' + d.index + '" class="display" style="margin-top: -30px; width:100%; border-right: 10px solid #ddd; border-left: 10px solid #ddd;">';
        result += "<thead><tr><th></th><th>Trace</th><th>Metric</th><th>Abs</th><th>Rel</th></tr></thead><tbody>";
        d.traces.forEach((value, index) => {
            result += "<tr>";
            result += '<td style="white-space: pre-wrap"></td>';
            let uids = value[0].toString().split(';');
            result += '<td style="white-space: pre-wrap">' + nodes[uids[0]] + ' ⇢ ' + nodes[uids[1]] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[1] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[2] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[3] + "</td>";
            result += '<td style="white-space: pre-wrap">' + value[4] + "</td>";
            result += "</tr>";
        });
        result += '</tbody></table>';
        return result;
    }

    function render() {
        Plotly.react('sankey_graph', sankey_data, layout, config);
    }

    function newplot() {
        Plotly.newPlot('sankey_graph', sankey_data, layout, config);
        refreshHandlers();
    }

    function hideNodes(worklist) {
        for (let i = sankey_data[0].link.source.length - 1; i >= 0; i--) {
            if (worklist.includes(sankey_data[0].link.source[i]) || worklist.includes(sankey_data[0].link.target[i])) {
                let key = sankey_data[0].link.source[i] + "," + sankey_data[0].link.target[i];
                processed_edges.delete(key);
                sankey_data[0].link.source.splice(i, 1);
                sankey_data[0].link.target.splice(i, 1);
                sankey_data[0].link.value.splice(i, 1);
                sankey_data[0].link.color.splice(i, 1);
                sankey_data[0].link.customdata.splice(i, 1);
            }
        }
    }

    function addToWorklist(worklist, nodedata) {
        let callees = callee_graph[nodedata.index][nodedata.pos]
        if (callees !== undefined) {
            for (callee in callees) {
                if (!hasNode(callee, nodedata.pos-1))
                    continue

                target = getNode(callee, nodedata.pos-1)
                if (custom_data[target].type === "none" || (nodedata.type !== custom_data[target].type && custom_data[target].type !== 'root')) {
                    console.log(worklist, target);
                    if (!worklist.includes(target)) {
                        worklist.push(target);
                        addToWorklist(worklist, sankey_data[0].node.customdata[target]);
                    }
                }
            }
        }
        let callers = caller_graph[nodedata.index][nodedata.pos]
        if (callers !== undefined) {
            for (caller in callers) {
                if (!hasNode(caller, nodedata.pos+1))
                    continue

                target = getNode(caller, nodedata.pos+1)
                if (custom_data[target].type === "none" || (nodedata.type !== custom_data[target].type && custom_data[target].type !== 'root')) {
                    console.log(worklist, target);
                    if (!worklist.includes(target)) {
                        worklist.push(target);
                        addToWorklist(worklist, sankey_data[0].node.customdata[target]);
                    }
                }
            }
        }
    }


    function foldnode(nodedata) {
        clickedNode = getNode(nodedata.index, nodedata.pos, false);
        custom_data = sankey_data[0].node.customdata;
        if (!nodedata.hidden && nodedata.type !== "root") {
            sankey_data[0].node.label[nodedata.id] = "[+] (" + nodedata.label + ")";
            nodedata.hidden = true;
            worklist = []
            addToWorklist(worklist, nodedata)
            hideNodes(worklist, nodedata.type)
        }
    }

    function unfoldnode(nodedata) {
        clickedNode = getNode(nodedata.index, nodedata.pos, false);
        if (nodedata.hidden) {
            addAllEdgesFor(clickedNode, nodedata.pos, callee_graph[nodedata.index][nodedata.pos], false, nodedata.type);
            addAllEdgesFor(clickedNode, nodedata.pos, caller_graph[nodedata.index][nodedata.pos], true, nodedata.type);
            sankey_data[0].node.label[nodedata.id] = nodedata.label;
            nodedata.hidden = false;
        }
    }

    function refreshHandlers() {
        plot.on('plotly_afterplot', function () {
            //annotateEdges();
        });
        plot.on('plotly_click', function (idata) {
            for (let i = 0; i < idata.points.length; i++) {
                clicked = idata.points[i];
                if (clicked.customdata !== undefined) {
                    if (modification_mode === 'fold') {
                        foldnode(clicked.customdata)
                    } else {
                        unfoldnode(clicked.customdata)
                    }
                }
            }
            // This will call render as well
            filterEdges();
        })
    }

    function filterEdges() {
        edges = sankey_data[0].link;
        let fromInput = document.getElementById('fromSlider').value;
        let toInput = document.getElementById('toSlider').value;
        for (let i = 0; i < edges.customdata.length; i++) {
            newValue = recomputeValue(edges.customdata[i].type, edges.customdata[i].stats);
            edges.value[i] = (fromInput <= newValue && newValue <= toInput) ? newValue : 0;
        }
        render();
    }

    function hasNode(node, pos) {
        node_len = shown_nodes.length;
        for (let i = 0; i < node_len; i++) {
            if (shown_nodes[i][0] === node && shown_nodes[i][1] === pos) {
                return i;
            }
        }
    }

    // Graph Operations
    function getNode(node, pos, isroot) {
        node_len = shown_nodes.length;

        for (let i = 0; i < node_len; i++) {
            if (shown_nodes[i][0] === node && shown_nodes[i][1] === pos) {
                return i;
            }
        }

        if (isroot) {
            sankey_data[0].node.color.push("rgba(0, 0, 0, 0.7)");
            sankey_data[0].node.label.push(nodes[node]);
            sankey_data[0].node.customdata.push({label: nodes[node], index: node, pos: pos, hidden: false, type: "root", id: node_len});
        } else {
            sankey_data[0].node.color.push("rgba(0, 0, 0, 0.2)");
            sankey_data[0].node.label.push("[+] (" + nodes[node] + ")");
            sankey_data[0].node.customdata.push({label: nodes[node], index: node, pos: pos, hidden: true, type: "none", id: node_len});
        }
        shown_nodes.push([node, pos])
        return node_len;
    }

    function clearGraph() {
        sankey_data[0].node.label = [];
        sankey_data[0].node.color = [];
        sankey_data[0].node.customdata = [];
        sankey_data[0].link.source = [];
        sankey_data[0].link.target = [];
        sankey_data[0].link.value = [];
        sankey_data[0].link.color = [];
        sankey_data[0].link.customdata = [];
        shown_nodes = [];
        processed_edges = new Set();
        steps = [];
    }

    function fillSliders(fromMin, fromVal, fromMax, toMin, toVal, toMax) {
        let fromSlider = document.getElementById('fromSlider');
        let toSlider = document.getElementById('toSlider');

        fromSlider.min = fromMin;
        fromSlider.value = fromVal;
        fromSlider.max = fromMax;
        toSlider.min = toMin;
        toSlider.value = toVal;
        toSlider.max = toMax;

        setInput(fromInput, fromVal);
        setInput(toInput, toVal);

        fillSlider(fromSlider, toSlider, '#C6C6C6', '#25daa5', toSlider);
    }

    function updateSliders(val) {
        if (val == 0 || val == 0.0) {
            return;
        }

        let fromSlider = document.getElementById('fromSlider');
        let toSlider = document.getElementById('toSlider');

        let minVal = Math.min(fromSlider.min, val);
        let maxVal = Math.max(toSlider.max, val);


        if (fromSlider.value !== fromSlider.min) {
            minVal = fromSlider.value
        }
        if (toSlider.value !== toSlider.max) {
            maxVal = toSlider.value
        }

        if (steps.length === 1) {
            fillSliders(val, val, val, val, val, val);
        } else {
            fillSliders(Math.min(fromSlider.min, val), minVal, Math.max(fromSlider.max, val), Math.min(toSlider.min, val), maxVal, Math.max(toSlider.max, val));
        }
    }

    function addToSteps(val) {
        let low = 0, high = steps.length - 1;

        while (low <= high) {
            let mid = Math.floor((low + high) / 2);
            if (steps[mid] === val) {
                return;
            } else if(steps[mid] < val) {
                low = mid + 1;
            } else {
                high = mid - 1;
            }
        }

        steps.splice(low, 0, val);
        updateSliders(val);
    }

    function addToSankey(src, target, val, color, type, edge_stats) {
        sankey_data[0].link.source.push(src);
        sankey_data[0].link.target.push(target);
        sankey_data[0].link.value.push(val);
        sankey_data[0].link.color.push(color);
        sankey_data[0].link.customdata.push({stats: edge_stats, type: type})
        addToSteps(val);
    }

    function recomputeValue(stat_type, edge_stats) {
        if (!isChecked(stat_type))
            return 0;

        // Baseline data
        let baseline_stat = edge_stats[selected_metric], target_stat = edge_stats[selected_metric+number_of_metrics];
        if (stat_type === "baseline")
            return baseline_stat;
        if (stat_type === "target")
            return target_stat;
        let diff = baseline_stat - target_stat;
        if (stat_type === "decr")
            return diff > 0 ? Math.abs(diff) : 0;
        if (stat_type === "incr")
            return diff <= 0 ? Math.abs(diff) : 0;
        if (stat_type === "both")
            return Math.min(baseline_stat, target_stat);
    }

    function expandOneLevel() {
        let nodes = sankey_data[0].node,
            caller_worklist = [],
            callee_worklist = [];
        // Collect the data
        for (let i = 0; i < nodes.customdata.length; i++) {
            let nodedata = nodes.customdata[i];
            if (nodedata.hidden) {
                if (nodedata.type === "callee") {
                    callee_worklist.push(nodedata);
                } else if (nodedata.type === "caller") {
                    caller_worklist.push(nodedata);
                }
            }
        }

        // Worklists
        while (caller_worklist.length != 0) {
            item = caller_worklist.shift();
            unfoldnode(item);
        }
        while (callee_worklist.length != 0) {
            item = callee_worklist.shift();
            unfoldnode(item);
        }

        filterEdges();
    }

    function addEdge(src, target, edge_stats) {
        // Baseline data
        let key = src + "," + target;
        if (processed_edges.has(key))
            return;

        let baseline_stat = edge_stats[selected_metric], target_stat = edge_stats[selected_metric+number_of_metrics];
        if (baseline_stat) {
            addToSankey(src, target, baseline_stat, "rgba(49, 48, 77, 0.4)", "baseline", edge_stats)
        }
        if (target_stat) {
            addToSankey(src, target, target_stat, "rgba(255, 201, 74, 0.4)", "target", edge_stats)
        }
        let diff = baseline_stat - target_stat;
        if (diff > 0) {
            // Baseline is higher
            addToSankey(src, target, diff, "rgba(0, 250, 0, 0.4)", "decr", edge_stats);
            addToSankey(src, target, 0, "rgba(255, 0, 0, 0.4)", "incr", edge_stats);
            addToSankey(src, target, Math.min(baseline_stat, target_stat), "rgba(0, 0, 255, 0.4)", "both", edge_stats);
        } else {
            addToSankey(src, target, Math.abs(diff), "rgba(250, 0, 0, 0.4)", "incr", edge_stats);
            addToSankey(src, target, 0, "rgba(0, 250, 0, 0.4)", "decr", edge_stats);
            addToSankey(src, target, Math.min(baseline_stat, target_stat), "rgba(0, 0, 255, 0.4)", "both", edge_stats);
        }
        processed_edges.add(key);
    }

    function adjustType(target, type) {
        tgt_data = sankey_data[0].node.customdata[target];
        if (tgt_data.type === "none") {
            tgt_data.type = type;
        };
    }

    function addAllEdgesFor(node, pos, edges, isfwd, newtype) {
        if (edges !== undefined) {
            for (edge in edges) {
                if (isfwd) {
                    let target = getNode(edge, pos+1, false);
                    addEdge(node, target, stats[edges[edge]]);
                    if (newtype === "caller") {
                        adjustType(target, newtype)
                    }
                } else {
                    let target = getNode(edge, pos-1, false);
                    addEdge(target, node, stats[edges[edge]]);
                    if (newtype === "callee") {
                        adjustType(target, newtype)
                    }
                }
            }
        }
    }

    function addRootNode(index) {
        // Add node to labels
        for (let i = 0; i < node_map[index].length; i++) {
            pos = node_map[index][i];
            rootNode = getNode(index, pos, true);
            addAllEdgesFor(rootNode, pos, callee_graph[index][pos], false, "callee");
            addAllEdgesFor(rootNode, pos, caller_graph[index][pos], true, "caller");
        }
    }

    function stat_id_to_name(stat_id) {
        let metric_len = stat_map.length;
        let metric = stat_id % metric_len;
        if (stat_id <= metric_len) {
            return 'callee ' + stat_map[metric];
        } else {
            return 'caller ' + stat_map[metric];
        }
    }

    // Event handlers
    selection_table.on('click', 'td.details-control', function(el) {
        var tr = $(this).closest('tr');
        var row = selection_table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
            tr.removeClass('shown');
            tr.addClass('hidden');
        } else {
            let d = row.data();
            row.child(format_row(d)).show();
            new DataTable("#metrics" + d.index, {paging: false, info: false, searching: false, order: [[1, 'desc']], columns: [
                    {
                        render: function(data, type) {
                            if (type === 'display') {
                                return stat_id_to_name(data);
                            }
                            return data;
                        }
                    }, {
                        render: function (data, type) {
                            if (type == "display") {
                                return format_value(data);
                            }
                            return data;
                        }
                    }, {
                        render: function (data, type) {
                            if (type == "display") {
                                return format_relative(data);
                            }
                            return data;
                        }
                    }
                ]});
            trace_table = new DataTable("#traces" + d.index, {
                columns: [
                    {
                        className: "inner-details-control",
                        orderable: false,
                        data: null,
                        defaultContent: "",
                        render: function () {
                            return '<span class="plus">[+]</span><span class="minus">[-]</span>';
                        },
                        width: "15px"
                    }, {}, {}, {
                        render: function (data, type) {
                            if (type === "display") {
                                return format_value(data);
                            }
                            return data;
                        }
                    }, {
                        render: function (data, type) {
                            if (type == "display") {
                                return format_relative(data);
                            }
                            return data;
                        }
                    }, {visible: false},
                ],
                createdRow: function( row, data, dataIndex ) {
                    $( row ).addClass('hidden');
                },
                paging: false,
                info: false,
                searching: false,
                order: [[3, "desc"]]
            });
            trace_table.on('click', 'td.inner-details-control', function(el) {
                var sub_tr = $(this).closest('tr');
                var sub_row = trace_table.row(sub_tr);

                if (sub_row.child.isShown()) {
                    sub_row.child.hide();
                    sub_tr.removeClass('shown');
                    sub_tr.addClass('hidden');
                } else {
                    sub_row.child(format_sub_row(sub_row.data(), d.uid)).show();
                    sub_tr.removeClass('hidden');
                    sub_tr.addClass('shown');
                }
            });
            tr.removeClass('hidden');
            tr.addClass('shown');
        }
    });

    function initializeGraph() {
        clearGraph();
        addRootNode(selected_uid);
        newplot();
        fillSliders(steps[0], steps[0], steps[steps.length-1], steps[0], steps[steps.length-1], steps[steps.length-1]);
        filterEdges();
    }

    selection_table.on('select', function(e, dt, type, indexes) {
        if (type === 'row') {
            let data = selection_table.rows(indexes).data();
            if (data.length > 0) {
                var div = document.getElementById('sankey_tools');
                if (div.style.display === "none") {
                    div.style.display = "block";
                }
                selected_uid = data[0].index;
                selected_uid_text = data[0].uid;
                layout.title = selected_uid_text;
                initializeGraph();
            }
        }
    })

    {% if stat_list|length > 1 %}
    document.getElementById("metricSelection").addEventListener('change', function() {
        selected_metric = parseInt(document.getElementById("metricSelection").value);
        let values = [];
        let edge_values = sankey_data[0].link.customdata;
        for (let i = 0; i < edge_values.length; i++) {
            baseline_metric = edge_values[i].stats[selected_metric];
            target_metric = edge_values[i].stats[selected_metric+number_of_metrics]
            // We skip empty metrics
            if (baseline_metric !== 0)
                values.push(baseline_metric);
            if (target_metric !== 0)
                values.push(target_metric);
        }

        // We adjust empty values
        if (values.length === 0) {
            steps = [0];
        } else {
            steps = Array.from(new Set(values)).sort((a, b) => a - b);
        }

        fillSliders(steps[0], steps[0], steps[steps.length-1], steps[0], steps[steps.length-1], steps[steps.length-1]);
        filterEdges();
    });
    {% endif %}

    function openTab(evt, tabName) {
      // Declare all variables
      var i, tabcontent, tablinks;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    document.querySelector('input[name="incr"]').addEventListener('change', filterEdges);
    document.querySelector('input[name="decr"]').addEventListener('change', filterEdges);
    document.querySelector('input[name="both"]').addEventListener('change', filterEdges);
    document.querySelector('input[name="baseline"]').addEventListener('change', filterEdges);
    document.querySelector('input[name="baseline"]').checked = false;
    document.querySelector('input[name="target"]').addEventListener('change', filterEdges);
    document.querySelector('input[name="target"]').checked = false;

    document.querySelector('#fromSlider').addEventListener('change', filterEdges);
    document.querySelector('#toSlider').addEventListener('change', filterEdges);

    {%- if flamegraphs %}
    document.getElementById("defaultOpen").click();
    {%- endif %}

    newplot()
</script>

</body>
</html>
